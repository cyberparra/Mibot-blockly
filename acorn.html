<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Testing blockly</title>
    <script src="blockly_compressed.js" charset="utf-8"></script>
    <script src="blocks_compressed.js" charset="utf-8"></script>
    <script src="javascript_compressed.js" charset="utf-8"></script>
    <script src="acorn.js"></script>
    <script src="interpreter.js"></script>


    <script src="msg/js/en.js" charset="utf-8"></script>
  </head>
  <body>
    <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>
    <button onclick="runCode(); return">Daje</button>
  </body>
  <script src="myBlocksInit.js" charset="utf-8"></script>

  <script src="myBlocks.js" charset="utf-8"></script>
  <script src="workspace.js" charset="utf-8"></script>
  <script>
  var myInterpreter;

  function highlightBlock(id) {

    workspace.highlightBlock(id);
    //console.log("step");
    //highlightPause = true;
  }
  var waitStep = 0;

  function wait(ms) {
    waitStep = ms;
  }

  function initApi(interpreter, scope) {
    console.log("init api");
    // Add an API function for highlighting blocks.
    var wrapper = function(id) {
      id = id ? id.toString() : '';
      return interpreter.createPrimitive(highlightBlock(id));
    };
    interpreter.setProperty(scope, 'highlightBlock',
        interpreter.createNativeFunction(wrapper));

    // Add an API function for "wait" blocks.
    var wrapper = function(id) {
      id = id ? id.toString() : '';
      return interpreter.createPrimitive(wait(id));
    };
    interpreter.setProperty(scope, 'wait',
        interpreter.createNativeFunction(wrapper));
  }



  function runCode() {
    Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    myInterpreter = new Interpreter(code, initApi);
    workspace.highlightBlock(null);
    //myInterpreter.run();
    function nextStep() {
      if (myInterpreter.step()) {

        window.setTimeout(nextStep, waitStep);
        waitStep = 0;
      } else {
        workspace.highlightBlock(null);
      }
    }
    nextStep();
  }
  </script>
</html>
